<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Li Shandross">

<title>Output type conversion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="supplementary-material_files/libs/clipboard/clipboard.min.js"></script>
<script src="supplementary-material_files/libs/quarto-html/quarto.js"></script>
<script src="supplementary-material_files/libs/quarto-html/popper.min.js"></script>
<script src="supplementary-material_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="supplementary-material_files/libs/quarto-html/anchor.min.js"></script>
<link href="supplementary-material_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="supplementary-material_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="supplementary-material_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="supplementary-material_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="supplementary-material_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overviewbackground" id="toc-overviewbackground" class="nav-link active" data-scroll-target="#overviewbackground">Overview/Background</a>
  <ul class="collapse">
  <li><a href="#example-1-samples---other-output-types" id="toc-example-1-samples---other-output-types" class="nav-link" data-scroll-target="#example-1-samples---other-output-types">Example 1: Samples -&gt; Other output types</a></li>
  <li><a href="#example-2-quantile---pmf" id="toc-example-2-quantile---pmf" class="nav-link" data-scroll-target="#example-2-quantile---pmf">Example 2: Quantile -&gt; PMF</a></li>
  </ul></li>
  <li><a href="#the-details" id="toc-the-details" class="nav-link" data-scroll-target="#the-details">The details</a>
  <ul class="collapse">
  <li><a href="#apistandardization" id="toc-apistandardization" class="nav-link" data-scroll-target="#apistandardization">API/Standardization</a></li>
  <li><a href="#supported-transformations" id="toc-supported-transformations" class="nav-link" data-scroll-target="#supported-transformations">Supported transformations</a></li>
  <li><a href="#underlying-transformation-calculations" id="toc-underlying-transformation-calculations" class="nav-link" data-scroll-target="#underlying-transformation-calculations">Underlying transformation calculations</a></li>
  <li><a href="#pmf-bin-handling" id="toc-pmf-bin-handling" class="nav-link" data-scroll-target="#pmf-bin-handling">PMF bin handling</a></li>
  <li><a href="#output-type-ids-dependent-on-task-ids" id="toc-output-type-ids-dependent-on-task-ids" class="nav-link" data-scroll-target="#output-type-ids-dependent-on-task-ids">Output type IDs dependent on task IDs</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Output type conversion</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Li Shandross </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hubExamples)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hubUtils)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hubData)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(idforecastutils)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"convert_output_types.R"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">width =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="overviewbackground" class="level2">
<h2 class="anchored" data-anchor-id="overviewbackground">Overview/Background</h2>
<p>We are sometimes interested in converting between output types, for use cases such as:</p>
<ol type="1">
<li>Summarizing distributions described by samples (e.g.&nbsp;obtaining a mean, median, or quantiles)
<ul>
<li>Often applicable to plotting</li>
</ul></li>
<li>Transforming from non-sample probabilistic output types (quantile, cdf, pmf) to other output types
<ul>
<li>e.g.&nbsp;quantile -&gt; pmf for FluSight 2023-2024</li>
</ul></li>
<li>Creating ensembles from samples</li>
</ol>
<p>This functionality is important as the hubverse moves toward greater support of the sample output type, as dealing with samples makes up a significant portion of use cases.</p>
<p>Implementation will also help us think about how we want to make ensembles of sample type forecasts within <code>hubEnsembles</code>, which has been a long-discussed topic with different iterations of ideas.</p>
<p>As of now, we do not provide many tools to deal with the sample output type</p>
<section id="example-1-samples---other-output-types" class="level3">
<h3 class="anchored" data-anchor-id="example-1-samples---other-output-types">Example 1: Samples -&gt; Other output types</h3>
<p>First, we print an example of sample output type forecasts from <code>hubExamples</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>hubExamples<span class="sc">::</span>forecast_outputs <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(output_type <span class="sc">==</span> <span class="st">"sample"</span>, output_type_id <span class="sc">%in%</span> <span class="dv">4301</span><span class="sc">:</span><span class="dv">4305</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">"target_end_date"</span>) <span class="co"># remove target_end_date column for readability</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 100 × 8</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    model_id          location reference_date horizon target          output_type output_type_id value</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;             &lt;chr&gt;    &lt;date&gt;           &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 Flusight-baseline 48       2022-11-19           0 wk inc flu hosp sample      4301            1032</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 Flusight-baseline 48       2022-11-19           0 wk inc flu hosp sample      4302            1169</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 Flusight-baseline 48       2022-11-19           0 wk inc flu hosp sample      4303            1062</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 Flusight-baseline 48       2022-11-19           0 wk inc flu hosp sample      4304            1063</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 Flusight-baseline 48       2022-11-19           0 wk inc flu hosp sample      4305            1068</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 Flusight-baseline 48       2022-11-19           1 wk inc flu hosp sample      4301             983</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 Flusight-baseline 48       2022-11-19           1 wk inc flu hosp sample      4302            1093</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 Flusight-baseline 48       2022-11-19           1 wk inc flu hosp sample      4303            1101</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 Flusight-baseline 48       2022-11-19           1 wk inc flu hosp sample      4304            1078</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 Flusight-baseline 48       2022-11-19           1 wk inc flu hosp sample      4305            1081</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 90 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These are trajectory samples, meaning that they are dependent across horizons for the same index. The <code>hubExamples</code> vignette plots a subset of the predictions for just Massachusetts with reference date December 17, 2022 generated by the “MOBS-GLEAM_FLUH” model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> hubExamples<span class="sc">::</span>forecast_target_ts <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(location <span class="sc">==</span> <span class="st">"25"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>             date <span class="sc">&gt;=</span> <span class="st">"2022-10-01"</span>, date <span class="sc">&lt;=</span> <span class="st">"2023-04-01"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observation)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> forecast_outputs <span class="sc">|&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        location <span class="sc">==</span> <span class="st">"25"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        model_id <span class="sc">==</span> <span class="st">"MOBS-GLEAM_FLUH"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        output_type <span class="sc">==</span> <span class="st">"sample"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> target_end_date, <span class="at">y =</span> value, <span class="at">group =</span> output_type_id),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"blue"</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.3</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="supplementary-material_files/figure-html/samples%20plot-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>We can get some idea of the underlying distribution by plotting, but we may be interested in summarizing the data points to obtain a mean, median, or quantile levels. Right now, we have a draft function in <code>hubUtils</code> that can perform these conversions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>converted_outputs <span class="ot">&lt;-</span> hubExamples<span class="sc">::</span>forecast_outputs <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(output_type <span class="sc">==</span> <span class="st">"sample"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">convert_output_type</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_output_type =</span> <span class="fu">c</span>(<span class="st">"quantile"</span>, <span class="st">"mean"</span>, <span class="st">"median"</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_output_type_id =</span> <span class="fu">list</span>(<span class="st">"quantile"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"mean"</span> <span class="ot">=</span> <span class="cn">NA</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"median"</span> <span class="ot">=</span> <span class="cn">NA</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>converted_outputs <span class="sc">|&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(output_type_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="cn">NA</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="st">"reference_date"</span>, <span class="st">"horizon"</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">"target_end_date"</span>) <span class="co"># remove target_end_date column for readability</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 240 × 8</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    model_id          location reference_date horizon target          output_type output_type_id value</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;             &lt;chr&gt;    &lt;date&gt;           &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;                &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp quantile              0.25  42  </span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp quantile              0.5   50.5</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp quantile              0.75  56  </span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp quantile              0.25  33  </span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp quantile              0.5   50  </span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp quantile              0.75  67.2</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp quantile              0.25  31.5</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp quantile              0.5   55.5</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp quantile              0.75  72  </span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 Flusight-baseline 25       2022-11-19           3 wk inc flu hosp quantile              0.25  29.8</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 230 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can also now plot these converted forecasts using <code>hubVis::plot_step_ahead_model output()</code> for the quantile and median output types, which produces a clean and simple plot of the underlying distribution. Below we show such predictions along with the observed hospital admission counts for Massachusetts and Texas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>converted_outputs <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(output_type <span class="sc">==</span> <span class="st">"quantile"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  hubVis<span class="sc">::</span><span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">target_data =</span> hubExamples<span class="sc">::</span>forecast_target_ts <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(location <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"25"</span>, <span class="st">"48"</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>             date <span class="sc">&gt;=</span> <span class="st">"2022-10-01"</span>, date <span class="sc">&lt;=</span> <span class="st">"2023-04-01"</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>),</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">facet =</span> <span class="st">"location"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"reference_date"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">interactive =</span> <span class="cn">FALSE</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="supplementary-material_files/figure-html/converted%20plots-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>Plotting the quantiles instead of the individual sample trajectories has the advantage of being able to clearly display multiple forecasts on the same plot.</p>
</section>
<section id="example-2-quantile---pmf" class="level3">
<h3 class="anchored" data-anchor-id="example-2-quantile---pmf">Example 2: Quantile -&gt; PMF</h3>
<p>Let’s print an example of quantile output type forecasts from <code>hubExamples</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>hubExamples<span class="sc">::</span>forecast_outputs <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(output_type <span class="sc">==</span> <span class="st">"quantile"</span>, output_type_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>)) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">"target_end_date"</span>) <span class="co"># remove target_end_date column for readability</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 144 × 8</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    model_id          location reference_date horizon target          output_type output_type_id value</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;             &lt;chr&gt;    &lt;date&gt;           &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp quantile    0.25              45</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp quantile    0.5               51</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp quantile    0.75              57</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp quantile    0.25              38</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp quantile    0.5               51</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp quantile    0.75              64</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp quantile    0.25              33</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp quantile    0.5               51</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp quantile    0.75              69</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 Flusight-baseline 25       2022-11-19           3 wk inc flu hosp quantile    0.25              29</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 134 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then plot the predictions, which are the quantile and median output types, along with the observed hospital admission counts for Massachusetts and Texas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>hubVis<span class="sc">::</span><span class="fu">plot_step_ahead_model_output</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">model_out_tbl =</span> hubExamples<span class="sc">::</span>forecast_outputs <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(output_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"quantile"</span>, <span class="st">"median"</span>)),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">target_data =</span> hubExamples<span class="sc">::</span>forecast_target_ts <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(location <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"25"</span>, <span class="st">"48"</span>),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>           date <span class="sc">&gt;=</span> <span class="st">"2022-10-01"</span>, date <span class="sc">&lt;=</span> <span class="st">"2023-04-01"</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">use_median_as_point =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_col_name =</span> <span class="st">"target_end_date"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">intervals =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">facet =</span> <span class="st">"location"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="st">"reference_date"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">interactive =</span> <span class="cn">FALSE</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="supplementary-material_files/figure-html/quantiles%20plot-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
<p>But we may be interested in converting these quantile forecasts into the pmf output type, like FluSight 2023-2024 which also used a target that categorized the change in influenza hospital admissions into several bins. A modified example of this can be shown using the <code>hubExamples</code> example forecast data and a conversion function <code>idforecastutils::transform_quantile_to_pmf()</code>.</p>
<p>Before we perform the transformation, though, we must first define the upper and lower endpoints of the categorical bins. In this example, we illustrate getting bin probabilities with different bin endpoints for each location. We bin hospital admissions into categories of “low”, “moderate”, “high”, and “very high”, with the bin endpoints equal to 2.5, 5, and 7.5 hospitalizations per 100,000 population, based on the populations of Massachusetts (FIPS code 25) and Texas (FIPS code 48) as reported by the US Census for 2022. (Because the used bins are of the half-open form (lower, upper), we use -Inf for the lower bin endpoint of the “low” category to capture the full predicted probability of that bin.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>state_pops <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"25"</span> <span class="ot">=</span> <span class="dv">6981974</span>, <span class="st">"48"</span> <span class="ot">=</span> <span class="dv">30029572</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>lower_multipliers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"low"</span> <span class="ot">=</span> <span class="sc">-</span><span class="cn">Inf</span>, <span class="st">"moderate"</span> <span class="ot">=</span> <span class="fl">2.5</span>, <span class="st">"high"</span> <span class="ot">=</span> <span class="fl">5.0</span>, <span class="st">"very high"</span> <span class="ot">=</span> <span class="fl">7.5</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>upper_multipliers <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"low"</span> <span class="ot">=</span> <span class="fl">2.5</span>, <span class="st">"moderate"</span> <span class="ot">=</span> <span class="fl">5.0</span>, <span class="st">"high"</span> <span class="ot">=</span> <span class="fl">7.5</span>, <span class="st">"very high"</span> <span class="ot">=</span> <span class="cn">Inf</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>bin_endpoints <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">location =</span> <span class="fu">c</span>(<span class="st">"25"</span>, <span class="st">"48"</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_type_id =</span> <span class="fu">c</span>(<span class="st">"low"</span>, <span class="st">"moderate"</span>, <span class="st">"high"</span>, <span class="st">"very high"</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> lower_multipliers[output_type_id] <span class="sc">*</span> state_pops[location] <span class="sc">/</span> <span class="dv">100000</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> upper_multipliers[output_type_id] <span class="sc">*</span> state_pops[location] <span class="sc">/</span> <span class="dv">100000</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(bin_endpoints)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   location output_type_id     lower     upper</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1       25            low      -Inf  174.5494</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2       48            low      -Inf  750.7393</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3       25       moderate  174.5494  349.0987</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4       48       moderate  750.7393 1501.4786</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5       25           high  349.0987  523.6481</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6       48           high 1501.4786 2252.2179</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7       25      very high  523.6481       Inf</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8       48      very high 2252.2179       Inf</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>pmf_outputs <span class="ot">&lt;-</span> hubExamples<span class="sc">::</span>forecast_outputs <span class="sc">|&gt;</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(output_type <span class="sc">==</span> <span class="st">"quantile"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  idforecastutils<span class="sc">::</span><span class="fu">transform_quantile_to_pmf</span>(<span class="at">bin_endpoints =</span> bin_endpoints) <span class="sc">|&gt;</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>pmf_outputs <span class="sc">|&gt;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="st">"target_end_date"</span>) <span class="co"># remove target_end_date column for readability</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 192 × 8</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    model_id          location reference_date horizon target          output_type output_type_id    value</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;             &lt;chr&gt;    &lt;date&gt;           &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;       &lt;chr&gt;             &lt;dbl&gt;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp pmf         low            1.00e+ 0</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp pmf         moderate       2.36e- 8</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp pmf         high           0       </span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 Flusight-baseline 25       2022-11-19           0 wk inc flu hosp pmf         very high      0       </span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp pmf         low            1.00e+ 0</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp pmf         moderate       3.30e- 4</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp pmf         high           8.59e-14</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 Flusight-baseline 25       2022-11-19           1 wk inc flu hosp pmf         very high      0       </span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp pmf         low            1.00e+ 0</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 Flusight-baseline 25       2022-11-19           2 wk inc flu hosp pmf         moderate       4.35e- 4</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 182 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then also plot these pmf forecasts with a plot that shows the predictive distributions for these targets from the three included models. Color indicates the predicted probability for each intensity category. The observed category is indicated with a <code>+</code> in the plot, while unobserved categories are indicated with an <code>o</code>. Here, the PMF value recorded in <code>forecast_target_observations</code> corresponds to a point mass at the observed category, with a value of 1 for the observed category and a value of 0 for the other categories.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract a subset of forecasts to plot and</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># set the output_type_id to be an ordered factor</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>pmf_cat_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"low"</span>, <span class="st">"moderate"</span>, <span class="st">"high"</span>, <span class="st">"very high"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>forecasts_to_plot <span class="ot">&lt;-</span> pmf_outputs <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(reference_date <span class="sc">==</span> <span class="st">"2022-12-17"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">output_type_id =</span> <span class="fu">factor</span>(output_type_id, <span class="at">levels =</span> pmf_cat_names, <span class="at">ordered =</span> <span class="cn">TRUE</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># extract the corresponding observations</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>observations_to_plot <span class="ot">&lt;-</span> hubExamples<span class="sc">::</span>forecast_target_observations <span class="sc">|&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    location <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"25"</span>, <span class="st">"48"</span>),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    target <span class="sc">==</span> <span class="st">"wk flu hosp rate category"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    target_end_date <span class="sc">%in%</span> forecasts_to_plot<span class="sc">$</span>target_end_date</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">output_type_id =</span> <span class="fu">factor</span>(output_type_id, <span class="at">levels =</span> pmf_cat_names, <span class="at">ordered =</span> <span class="cn">TRUE</span>))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the predictions and observations</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> target_end_date, <span class="at">y =</span> output_type_id, <span class="at">fill =</span> value),</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> forecasts_to_plot</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">0</span>, <span class="at">to =</span> <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.2</span>),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> target_end_date, <span class="at">y =</span> output_type_id,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>                  <span class="at">shape =</span> <span class="fu">factor</span>(observation)),</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"#888888"</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>, <span class="at">stroke =</span> <span class="dv">2</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> observations_to_plot,</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(model_id), <span class="at">cols =</span> <span class="fu">vars</span>(location)) <span class="sc">+</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"output_type_id (intensity level category)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="supplementary-material_files/figure-html/pmf%20plots-1.png" class="img-fluid figure-img" width="864"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-details" class="level2">
<h2 class="anchored" data-anchor-id="the-details">The details</h2>
<section id="apistandardization" class="level3">
<h3 class="anchored" data-anchor-id="apistandardization">API/Standardization</h3>
<p>Currently, we have two different functions that perform output type transformations:</p>
<ul>
<li><code>hubUtils::convert_output_types(model_out_tbl, new_output_type, new_output_type_id, n_samples, ...)</code></li>
<li><code>idforecastutils::transform_quantile_to_pmf(model_out_tbl, bin_endpoints, tail_dist)</code></li>
</ul>
<p>We would like to unify these two functions, and previous discussion had suggested we create a single user-facing function to handle all data type conversions, which would do so by calling the appropriate internal functions.</p>
<p>Here, we propose simply expanding <code>convert_output_types()</code> to handle the quantile to PMF case, as the <code>bin_endpoints</code> argument can be thought of as specifying the <code>new_output_type_id</code>. An example call might look like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>hubUtils<span class="sc">::</span><span class="fu">convert_output_types</span>(model_out_tbl,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">new_output_type =</span> <span class="st">"pmf"</span>, </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">new_output_type_id =</span> bin_endpoints,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                               <span class="at">n_samples =</span> <span class="cn">NULL</span>, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note the <code>n_samples</code> argument will specify the number of samples to generate per unique modeling task if the underlying calculation being performed requires samples. (Currently most conversions do, but we plan to change the internal mechanisms going forward. See Underlying transformation calculations for more information.)</p>
</section>
<section id="supported-transformations" class="level3">
<h3 class="anchored" data-anchor-id="supported-transformations">Supported transformations</h3>
<p>Summary of currently supported transformations (quantile -&gt; pmf currently performed by <code>transform_quantile_to_pmf()</code>):</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Initial output type</th>
<th style="text-align: left;">Terminal output type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sample</td>
<td style="text-align: left;">mean, median, quantile, cdf</td>
</tr>
<tr class="even">
<td style="text-align: left;">quantile</td>
<td style="text-align: left;">mean, median, cdf, <em>pmf</em></td>
</tr>
<tr class="odd">
<td style="text-align: left;">cdf</td>
<td style="text-align: left;">mean, median, quantile</td>
</tr>
</tbody>
</table>
<p>Ideally, we would like to add support in the future for:</p>
<ol type="1">
<li>Samples as a terminal output type</li>
<li>PMF as an initial output type</li>
<li>PMF as a terminal output type for CDF (and maybe sample)</li>
<li>(Interpolation/extrapolation for quantile to quantile and cdf to cdf transformations)</li>
<li>[Allow for the initial model outputs to contain multiple output types, with the ability to specify transformations to be performed]</li>
</ol>
</section>
<section id="underlying-transformation-calculations" class="level3">
<h3 class="anchored" data-anchor-id="underlying-transformation-calculations">Underlying transformation calculations</h3>
<p>Currently, <code>convert_output_type()</code> performs the transformation calculations by reconstructing a full probabilistic distribution from the starting forecasts using pseudo-random samples, generated from <code>distfromq</code>, then obtained the new output types from those samples. (The one exception for the quantile -&gt; median conversion.)</p>
<p>However, this method is somewhat inefficient and leads to unnecessary sampling error for certain transformations. Instead, we will split the type of intermediary step based on the terminal output type:</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">Terminal output type</th>
<th style="text-align: left;">Underlying calculation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sample</td>
<td style="text-align: left;">pseudo-random samples</td>
</tr>
<tr class="even">
<td style="text-align: left;">mean</td>
<td style="text-align: left;">pseudo-random samples</td>
</tr>
<tr class="odd">
<td style="text-align: left;">median</td>
<td style="text-align: left;">estimated quantile function</td>
</tr>
<tr class="even">
<td style="text-align: left;">quantile</td>
<td style="text-align: left;">estimated quantile function</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cdf</td>
<td style="text-align: left;">estimated cumulative distribution function</td>
</tr>
<tr class="even">
<td style="text-align: left;">pmf</td>
<td style="text-align: left;">estimated cumulative distribution function</td>
</tr>
</tbody>
</table>
</section>
<section id="pmf-bin-handling" class="level3">
<h3 class="anchored" data-anchor-id="pmf-bin-handling">PMF bin handling</h3>
<p>Recall that for a terminal output type of PMF, we needed to specify the upper and lower bin endpoints of the categories (see Example 2).</p>
<p>Likewise for a PMF initial output type, we will also need a way for the user to provide bin endpoints. However, we currently do not have a parameter that can be fed such an argument and thus need to create one.</p>
<p>Consider adding an argument to the output type conversion function <code>initial_output_type_id</code> or <code>initial_bin_endpoints</code> that can store this information when needed and be set to NULL (as a default) otherwise.</p>
</section>
<section id="output-type-ids-dependent-on-task-ids" class="level3">
<h3 class="anchored" data-anchor-id="output-type-ids-dependent-on-task-ids">Output type IDs dependent on task IDs</h3>
<p>There are cases in which output type IDs may be dependent on task IDs, like the FluSight 2023-2024 PMF target (see Example 2 for simplified version). Here, the bin category definitions were dependent on horizon and location. As this feature was requested by CDC FluSight and we at UMass need it for our flu models, we will plan on implementing it for all supported (probabilistic) terminal output type transformations.</p>
<p>Additionally, the (original) US COVID-19 Forecast Hub presents a case in which the quantile levels differ based on target. We envision the encoding of this dependency to look something like the following (borrowing elements from the quantile to pmf handling of bins), which would then be fed to the <code>new_output_type_id</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>quantile_levels <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand.grid</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="st">"wk ahead inc case"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_type_id =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.100</span>, <span class="fl">0.250</span>, <span class="fl">0.500</span>, <span class="fl">0.750</span>, <span class="fl">0.900</span>, <span class="fl">0.975</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand.grid</span>(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="fu">c</span>(<span class="st">"wk ahead inc death"</span>, <span class="st">"wk ahead cum death"</span>, <span class="st">"day ahead inc hosp"</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_type_id =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.025</span>, <span class="fu">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="at">by =</span> <span class="fl">0.05</span>), <span class="fl">0.975</span>, <span class="fl">0.99</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(target)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(quantile_levels, <span class="at">n =</span> <span class="dv">15</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                target output_type_id</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1   wk ahead inc case          0.025</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2   wk ahead inc case          0.100</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3   wk ahead inc case          0.250</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4   wk ahead inc case          0.500</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5   wk ahead inc case          0.750</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6   wk ahead inc case          0.900</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7   wk ahead inc case          0.975</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 8  wk ahead inc death          0.010</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9  wk ahead inc death          0.025</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 wk ahead inc death          0.050</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 11 wk ahead inc death          0.100</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 12 wk ahead inc death          0.150</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 13 wk ahead inc death          0.200</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 14 wk ahead inc death          0.250</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 15 wk ahead inc death          0.300</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>